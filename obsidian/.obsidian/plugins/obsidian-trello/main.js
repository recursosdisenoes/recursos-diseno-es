"use strict";var e=require("obsidian"),t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,n)};
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function n(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var r=function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function i(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{a(r.next(e))}catch(e){o(e)}}function l(e){try{a(r.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,l)}a((r=r.apply(e,t||[])).next())}))}function o(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(o){return function(l){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}}function s(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function l(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function a(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}function c(e){return this instanceof c?(this.v=e,this):new c(e)}function u(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),o=[];return r={},s("next"),s("throw"),s("return"),r[Symbol.asyncIterator]=function(){return this},r;function s(e){i[e]&&(r[e]=function(t){return new Promise((function(n,r){o.push([e,t,n,r])>1||l(e,t)}))})}function l(e,t){try{(n=i[e](t)).value instanceof c?Promise.resolve(n.value.v).then(a,u):d(o[0][2],n)}catch(e){d(o[0][3],e)}var n}function a(e){l("next",e)}function u(e){l("throw",e)}function d(e,t){e(t),o.shift(),o.length&&l(o[0][0],o[0][1])}}function d(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e=s(e),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,i){(function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)})(r,i,(t=e[n](t)).done,t.value)}))}}}function h(e){return"function"==typeof e}function p(e){var t=e((function(e){Error.call(e),e.stack=(new Error).stack}));return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var g=p((function(e){return function(t){e(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}}));function f(e,t){if(e){var n=e.indexOf(t);0<=n&&e.splice(n,1)}}var v=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._teardowns=null}var t;return e.prototype.unsubscribe=function(){var e,t,n,r,i;if(!this.closed){this.closed=!0;var o=this._parentage;if(o)if(this._parentage=null,Array.isArray(o))try{for(var c=s(o),u=c.next();!u.done;u=c.next()){u.value.remove(this)}}catch(t){e={error:t}}finally{try{u&&!u.done&&(t=c.return)&&t.call(c)}finally{if(e)throw e.error}}else o.remove(this);var d=this.initialTeardown;if(h(d))try{d()}catch(e){i=e instanceof g?e.errors:[e]}var p=this._teardowns;if(p){this._teardowns=null;try{for(var f=s(p),v=f.next();!v.done;v=f.next()){var m=v.value;try{y(m)}catch(e){i=null!=i?i:[],e instanceof g?i=a(a([],l(i)),l(e.errors)):i.push(e)}}}catch(e){n={error:e}}finally{try{v&&!v.done&&(r=f.return)&&r.call(f)}finally{if(n)throw n.error}}}if(i)throw new g(i)}},e.prototype.add=function(t){var n;if(t&&t!==this)if(this.closed)y(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._teardowns=null!==(n=this._teardowns)&&void 0!==n?n:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&f(t,e)},e.prototype.remove=function(t){var n=this._teardowns;n&&f(n,t),t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e}(),m=v.EMPTY;function b(e){return e instanceof v||e&&"closed"in e&&h(e.remove)&&h(e.add)&&h(e.unsubscribe)}function y(e){h(e)?e():e.unsubscribe()}var w={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},C={setTimeout:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=C.delegate;return((null==n?void 0:n.setTimeout)||setTimeout).apply(void 0,a([],l(e)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function T(e){C.setTimeout((function(){throw e}))}function S(){}function E(e){e()}var k=function(e){function t(t){var n=e.call(this)||this;return n.isStopped=!1,t?(n.destination=t,b(t)&&t.add(n)):n.destination=L,n}return n(t,e),t.create=function(e,t,n){return new x(e,t,n)},t.prototype.next=function(e){this.isStopped||this._next(e)},t.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(v),x=function(e){function t(t,n,r){var i,o=e.call(this)||this;if(h(t))i=t;else if(t){var s;i=t.next,n=t.error,r=t.complete,o&&w.useDeprecatedNextContext?(s=Object.create(t)).unsubscribe=function(){return o.unsubscribe()}:s=t,i=null==i?void 0:i.bind(s),n=null==n?void 0:n.bind(s),r=null==r?void 0:r.bind(s)}return o.destination={next:i?I(i):S,error:I(null!=n?n:P),complete:r?I(r):S},o}return n(t,e),t}(k);function I(e,t){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];try{e.apply(void 0,a([],l(t)))}catch(e){T(e)}}}function P(e){throw e}var L={closed:!0,next:S,error:P,complete:S},A="function"==typeof Symbol&&Symbol.observable||"@@observable";function D(e){return e}function M(e){return 0===e.length?D:1===e.length?e[0]:function(t){return e.reduce((function(e,t){return t(e)}),t)}}var _=function(){function e(e){e&&(this._subscribe=e)}return e.prototype.lift=function(t){var n=new e;return n.source=this,n.operator=t,n},e.prototype.subscribe=function(e,t,n){var r,i=this,o=(r=e)&&r instanceof k||function(e){return e&&h(e.next)&&h(e.error)&&h(e.complete)}(r)&&b(r)?e:new x(e,t,n);return E((function(){var e=i,t=e.operator,n=e.source;o.add(t?t.call(o,n):n?i._subscribe(o):i._trySubscribe(o))})),o},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},e.prototype.forEach=function(e,t){var n=this;return new(t=O(t))((function(t,r){var i;i=n.subscribe((function(t){try{e(t)}catch(e){r(e),null==i||i.unsubscribe()}}),r,t)}))},e.prototype._subscribe=function(e){var t;return null===(t=this.source)||void 0===t?void 0:t.subscribe(e)},e.prototype[A]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return M(e)(this)},e.prototype.toPromise=function(e){var t=this;return new(e=O(e))((function(e,n){var r;t.subscribe((function(e){return r=e}),(function(e){return n(e)}),(function(){return e(r)}))}))},e.create=function(t){return new e(t)},e}();function O(e){var t;return null!==(t=null!=e?e:w.Promise)&&void 0!==t?t:Promise}function N(e){return function(t){if(function(e){return h(null==e?void 0:e.lift)}(t))return t.lift((function(t){try{return e(t,this)}catch(e){this.error(e)}}));throw new TypeError("Unable to lift unknown Observable type")}}var B=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;return s.onFinalize=o,s._next=n?function(e){try{n(e)}catch(e){t.error(e)}}:e.prototype._next,s._error=i?function(e){try{i(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._error,s._complete=r?function(){try{r()}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._complete,s}return n(t,e),t.prototype.unsubscribe=function(){var t,n=this.closed;e.prototype.unsubscribe.call(this),!n&&(null===(t=this.onFinalize)||void 0===t||t.call(this))},t}(k),U=p((function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}})),$=function(e){function t(){var t=e.call(this)||this;return t.closed=!1,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return n(t,e),t.prototype.lift=function(e){var t=new V(this,this);return t.operator=e,t},t.prototype._throwIfClosed=function(){if(this.closed)throw new U},t.prototype.next=function(e){var t=this;E((function(){var n,r;if(t._throwIfClosed(),!t.isStopped){var i=t.observers.slice();try{for(var o=s(i),l=o.next();!l.done;l=o.next()){l.value.next(e)}}catch(e){n={error:e}}finally{try{l&&!l.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}}}))},t.prototype.error=function(e){var t=this;E((function(){if(t._throwIfClosed(),!t.isStopped){t.hasError=t.isStopped=!0,t.thrownError=e;for(var n=t.observers;n.length;)n.shift().error(e)}}))},t.prototype.complete=function(){var e=this;E((function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var t=e.observers;t.length;)t.shift().complete()}}))},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var e;return(null===(e=this.observers)||void 0===e?void 0:e.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(t){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,t)},t.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},t.prototype._innerSubscribe=function(e){var t=this,n=t.hasError,r=t.isStopped,i=t.observers;return n||r?m:(i.push(e),new v((function(){return f(i,e)})))},t.prototype._checkFinalizedStatuses=function(e){var t=this,n=t.hasError,r=t.thrownError,i=t.isStopped;n?e.error(r):i&&e.complete()},t.prototype.asObservable=function(){var e=new _;return e.source=this,e},t.create=function(e,t){return new V(e,t)},t}(_),V=function(e){function t(t,n){var r=e.call(this)||this;return r.destination=t,r.source=n,r}return n(t,e),t.prototype.next=function(e){var t,n;null===(n=null===(t=this.destination)||void 0===t?void 0:t.next)||void 0===n||n.call(t,e)},t.prototype.error=function(e){var t,n;null===(n=null===(t=this.destination)||void 0===t?void 0:t.error)||void 0===n||n.call(t,e)},t.prototype.complete=function(){var e,t;null===(t=null===(e=this.destination)||void 0===e?void 0:e.complete)||void 0===t||t.call(e)},t.prototype._subscribe=function(e){var t,n;return null!==(n=null===(t=this.source)||void 0===t?void 0:t.subscribe(e))&&void 0!==n?n:m},t}($),j=function(e){function t(t){var n=e.call(this)||this;return n._value=t,n}return n(t,e),Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(t){var n=e.prototype._subscribe.call(this,t);return!n.closed&&t.next(this._value),n},t.prototype.getValue=function(){var e=this,t=e.hasError,n=e.thrownError,r=e._value;if(t)throw n;return this._throwIfClosed(),r},t.prototype.next=function(t){e.prototype.next.call(this,this._value=t)},t}($),R=function(){return Date.now()},F=function(e){function t(t,n){return e.call(this)||this}return n(t,e),t.prototype.schedule=function(e,t){return this},t}(v),z={setInterval:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=z.delegate;return((null==n?void 0:n.setInterval)||setInterval).apply(void 0,a([],l(e)))},clearInterval:function(e){return clearInterval(e)},delegate:void 0},H=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.scheduler=t,r.work=n,r.pending=!1,r}return n(t,e),t.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e;var n=this.id,r=this.scheduler;return null!=n&&(this.id=this.recycleAsyncId(r,n,t)),this.pending=!0,this.delay=t,this.id=this.id||this.requestAsyncId(r,this.id,t),this},t.prototype.requestAsyncId=function(e,t,n){return void 0===n&&(n=0),z.setInterval(e.flush.bind(e,this),n)},t.prototype.recycleAsyncId=function(e,t,n){if(void 0===n&&(n=0),null!=n&&this.delay===n&&!1===this.pending)return t;z.clearInterval(t)},t.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var n=this._execute(e,t);if(n)return n;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(e,t){var n,r=!1;try{this.work(e)}catch(e){r=!0,n=!!e&&e||new Error(e)}if(r)return this.unsubscribe(),n},t.prototype.unsubscribe=function(){if(!this.closed){var t=this.id,n=this.scheduler,r=n.actions;this.work=this.state=this.scheduler=null,this.pending=!1,f(r,this),null!=t&&(this.id=this.recycleAsyncId(n,t,null)),this.delay=null,e.prototype.unsubscribe.call(this)}},t}(F),q=function(){function e(t,n){void 0===n&&(n=e.now),this.schedulerActionCtor=t,this.now=n}return e.prototype.schedule=function(e,t,n){return void 0===t&&(t=0),new this.schedulerActionCtor(this,e).schedule(n,t)},e.now=R,e}(),Q=new(function(e){function t(t,n){void 0===n&&(n=q.now);var r=e.call(this,t,n)||this;return r.actions=[],r._active=!1,r._scheduled=void 0,r}return n(t,e),t.prototype.flush=function(e){var t=this.actions;if(this._active)t.push(e);else{var n;this._active=!0;do{if(n=e.execute(e.state,e.delay))break}while(e=t.shift());if(this._active=!1,n){for(;e=t.shift();)e.unsubscribe();throw n}}},t}(q))(H),W=Q,G=new _((function(e){return e.complete()}));function Y(e,t){return new _((function(n){var r=0;return t.schedule((function(){r===e.length?n.complete():(n.next(e[r++]),n.closed||this.schedule())}))}))}var X=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function J(e){return h(null==e?void 0:e.then)}var Z="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function K(e,t){if(!e)throw new Error("Iterable cannot be null");return new _((function(n){var r=new v;return r.add(t.schedule((function(){var i=e[Symbol.asyncIterator]();r.add(t.schedule((function(){var e=this;i.next().then((function(t){t.done?n.complete():(n.next(t.value),e.schedule())}))})))}))),r}))}function ee(e){return h(e[A])}function te(e){return h(null==e?void 0:e[Z])}function ne(e){return Symbol.asyncIterator&&h(null==e?void 0:e[Symbol.asyncIterator])}function re(e){return new TypeError("You provided "+(null!==e&&"object"==typeof e?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function ie(e){return u(this,arguments,(function(){var t,n,r;return o(this,(function(i){switch(i.label){case 0:t=e.getReader(),i.label=1;case 1:i.trys.push([1,,9,10]),i.label=2;case 2:return[4,c(t.read())];case 3:return n=i.sent(),r=n.value,n.done?[4,c(void 0)]:[3,5];case 4:return[2,i.sent()];case 5:return[4,c(r)];case 6:return[4,i.sent()];case 7:return i.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}}))}))}function oe(e){return h(null==e?void 0:e.getReader)}function se(e,t){if(null!=e){if(ee(e))return function(e,t){return new _((function(n){var r=new v;return r.add(t.schedule((function(){var i=e[A]();r.add(i.subscribe({next:function(e){r.add(t.schedule((function(){return n.next(e)})))},error:function(e){r.add(t.schedule((function(){return n.error(e)})))},complete:function(){r.add(t.schedule((function(){return n.complete()})))}}))}))),r}))}(e,t);if(X(e))return Y(e,t);if(J(e))return function(e,t){return new _((function(n){return t.schedule((function(){return e.then((function(e){n.add(t.schedule((function(){n.next(e),n.add(t.schedule((function(){return n.complete()})))})))}),(function(e){n.add(t.schedule((function(){return n.error(e)})))}))}))}))}(e,t);if(ne(e))return K(e,t);if(te(e))return function(e,t){return new _((function(n){var r;return n.add(t.schedule((function(){r=e[Z](),function(e,t,n,r){void 0===r&&(r=0);var i=t.schedule((function(){try{n.call(this)}catch(t){e.error(t)}}),r);e.add(i)}(n,t,(function(){var e=r.next(),t=e.value;e.done?n.complete():(n.next(t),this.schedule())}))}))),function(){return h(null==r?void 0:r.return)&&r.return()}}))}(e,t);if(oe(e))return function(e,t){return K(ie(e),t)}(e,t)}throw re(e)}function le(e,t){return t?se(e,t):ae(e)}function ae(e){if(e instanceof _)return e;if(null!=e){if(ee(e))return r=e,new _((function(e){var t=r[A]();if(h(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")}));if(X(e))return ce(e);if(J(e))return n=e,new _((function(e){n.then((function(t){e.closed||(e.next(t),e.complete())}),(function(t){return e.error(t)})).then(null,T)}));if(ne(e))return ue(e);if(te(e))return t=e,new _((function(e){var n,r;try{for(var i=s(t),o=i.next();!o.done;o=i.next()){var l=o.value;if(e.next(l),e.closed)return}}catch(e){n={error:e}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}e.complete()}));if(oe(e))return ue(ie(e))}var t,n,r;throw re(e)}function ce(e){return new _((function(t){for(var n=0;n<e.length&&!t.closed;n++)t.next(e[n]);t.complete()}))}function ue(e){return new _((function(t){(function(e,t){var n,r,s,l;return i(this,void 0,void 0,(function(){var i,a;return o(this,(function(o){switch(o.label){case 0:o.trys.push([0,5,6,11]),n=d(e),o.label=1;case 1:return[4,n.next()];case 2:if((r=o.sent()).done)return[3,4];if(i=r.value,t.next(i),t.closed)return[2];o.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=o.sent(),s={error:a},[3,11];case 6:return o.trys.push([6,,9,10]),r&&!r.done&&(l=n.return)?[4,l.call(n)]:[3,8];case 7:o.sent(),o.label=8;case 8:return[3,10];case 9:if(s)throw s.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}}))}))})(e,t).catch((function(e){return t.error(e)}))}))}function de(e,t){return t?Y(e,t):ce(e)}function he(e){return e&&h(e.schedule)}function pe(e){return e[e.length-1]}function ge(e){return h(pe(e))?e.pop():void 0}function fe(e){return he(pe(e))?e.pop():void 0}function ve(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=fe(e);return n?Y(e,n):de(e)}function me(e,t){var n=h(e)?e:function(){return e},r=function(e){return e.error(n())};return new _(t?function(e){return t.schedule(r,0,e)}:r)}function be(e,t){return N((function(n,r){var i=0;n.subscribe(new B(r,(function(n){r.next(e.call(t,n,i++))})))}))}var ye=Array.isArray;function we(e){return be((function(t){return function(e,t){return ye(t)?e.apply(void 0,a([],l(t))):e(t)}(e,t)}))}var Ce=Array.isArray,Te=Object.getPrototypeOf,Se=Object.prototype,Ee=Object.keys;function ke(e){if(1===e.length){var t=e[0];if(Ce(t))return{args:t,keys:null};if((r=t)&&"object"==typeof r&&Te(r)===Se){var n=Ee(t);return{args:n.map((function(e){return t[e]})),keys:n}}}var r;return{args:e,keys:null}}function xe(e,t){return e.reduce((function(e,n,r){return e[n]=t[r],e}),{})}function Ie(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=fe(e),r=ge(e),i=ke(e),o=i.args,s=i.keys;if(0===o.length)return le([],n);var l=new _(Pe(o,n,s?function(e){return xe(s,e)}:D));return r?l.pipe(we(r)):l}function Pe(e,t,n){return void 0===n&&(n=D),function(r){Le(t,(function(){for(var i=e.length,o=new Array(i),s=i,l=i,a=function(i){Le(t,(function(){var a=le(e[i],t),c=!1;a.subscribe(new B(r,(function(e){o[i]=e,c||(c=!0,l--),l||r.next(n(o.slice()))}),(function(){--s||r.complete()})))}),r)},c=0;c<i;c++)a(c)}),r)}}function Le(e,t,n){e?n.add(e.schedule(t)):t()}function Ae(e,t,n){return void 0===n&&(n=1/0),h(t)?Ae((function(n,r){return be((function(e,i){return t(n,e,r,i)}))(ae(e(n,r)))}),n):("number"==typeof t&&(n=t),N((function(t,r){return function(e,t,n,r,i,o,s,l){var a=[],c=0,u=0,d=!1,h=function(){!d||a.length||c||t.complete()},p=function(e){return c<r?g(e):a.push(e)},g=function(e){o&&t.next(e),c++;var l=!1;ae(n(e,u++)).subscribe(new B(t,(function(e){null==i||i(e),o?p(e):t.next(e)}),(function(){l=!0}),void 0,(function(){if(l)try{c--;for(var e=function(){var e=a.shift();s?t.add(s.schedule((function(){return g(e)}))):g(e)};a.length&&c<r;)e();h()}catch(e){t.error(e)}})))};return e.subscribe(new B(t,p,(function(){d=!0,h()}))),function(){null==l||l()}}(t,r,e,n)})))}function De(){return void 0===(e=1)&&(e=1/0),Ae(D,e);var e}function Me(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return De()(de(e,fe(e)))}function _e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=ge(e),r=ke(e),i=r.args,o=r.keys,s=new _((function(e){var t=i.length;if(t)for(var n=new Array(t),r=t,s=t,l=function(t){var l=!1;ae(i[t]).subscribe(new B(e,(function(e){l||(l=!0,s--),n[t]=e}),(function(){--r&&l||(s||e.next(o?xe(o,n):n),e.complete())})))},a=0;a<t;a++)l(a);else e.complete()}));return n?s.pipe(we(n)):s}function Oe(e,t,n){return r=function(){return e()?t:n},new _((function(e){ae(r()).subscribe(e)}));var r}function Ne(e,t,n){void 0===e&&(e=0),void 0===n&&(n=W);var r=-1;return null!=t&&(he(t)?n=t:r=t),new _((function(t){var i,o=(i=e)instanceof Date&&!isNaN(i)?+e-n.now():e;o<0&&(o=0);var s=0;return n.schedule((function(){t.closed||(t.next(s++),0<=r?this.schedule(void 0,r):t.complete())}),o)}))}function Be(e,t){return N((function(n,r){var i=0;n.subscribe(new B(r,(function(n){return e.call(t,n,i++)&&r.next(n)})))}))}function Ue(e){return N((function(t,n){var r,i=null,o=!1;i=t.subscribe(new B(n,void 0,void 0,(function(s){r=ae(e(s,Ue(e)(t))),i?(i.unsubscribe(),i=null,r.subscribe(n)):o=!0}))),o&&(i.unsubscribe(),i=null,r.subscribe(n))}))}function $e(e,t){return h(t)?Ae(e,t,1):Ae(e,1)}function Ve(e){return e<=0?function(){return G}:N((function(t,n){var r=0;t.subscribe(new B(n,(function(t){++r<=e&&(n.next(t),e<=r&&n.complete())})))}))}function je(e,t){return t?function(n){return Me(t.pipe(Ve(1),N((function(e,t){e.subscribe(new B(t,S))}))),n.pipe(je(e)))}:Ae((function(t,n){return e(t,n).pipe(Ve(1),function(e){return be((function(){return e}))}(t))}))}function Re(e){return N((function(t,n){try{t.subscribe(n)}finally{n.add(e)}}))}function Fe(e,t){return N((function(n,r){var i=null,o=0,s=!1,l=function(){return s&&!i&&r.complete()};n.subscribe(new B(r,(function(n){null==i||i.unsubscribe();var s=0,a=o++;ae(e(n,a)).subscribe(i=new B(r,(function(e){return r.next(t?t(n,e,a,s++):e)}),(function(){i=null,l()})))}),(function(){s=!0,l()})))}))}function ze(e){return N((function(t,n){ae(e).subscribe(new B(n,(function(){return n.complete()}),S)),!n.closed&&t.subscribe(n)}))}function He(e,t,n){var r=h(e)||t||n?{next:e,error:t,complete:n}:e;return r?N((function(e,t){var n;null===(n=r.subscribe)||void 0===n||n.call(r);var i=!0;e.subscribe(new B(t,(function(e){var n;null===(n=r.next)||void 0===n||n.call(r,e),t.next(e)}),(function(){var e;i=!1,null===(e=r.complete)||void 0===e||e.call(r),t.complete()}),(function(e){var n;i=!1,null===(n=r.error)||void 0===n||n.call(r,e),t.error(e)}),(function(){var e,t;i&&(null===(e=r.unsubscribe)||void 0===e||e.call(r)),null===(t=r.finalize)||void 0===t||t.call(r)})))})):D}if("undefined"!=typeof navigator&&"ReactNative"===navigator.product&&"undefined"==typeof crypto)throw new Error("React Native does not have a built-in secure random generator. If you don’t need unpredictable IDs use `nanoid/non-secure`. For secure IDs, import `react-native-get-random-values` before Nano ID.");if("undefined"!=typeof msCrypto&&"undefined"==typeof crypto)throw new Error("Import file with `if (!window.crypto) window.crypto = window.msCrypto` before importing Nano ID to fix IE 11 support");if("undefined"==typeof crypto)throw new Error("Your browser does not have secure random generator. If you don’t need unpredictable IDs, you can use nanoid/non-secure.");let qe=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;){let r=63&n[e];t+=r<36?r.toString(36):r<62?(r-26).toString(36).toUpperCase():r<63?"_":"-"}return t};var Qe,We,Ge,Ye,Xe,Je,Ze;!function(e){e.NoToken="NoToken",e.Unauthorized="Unauthorized",e.RateLimit="RateLimit",e.Unknown="Unknown",e.Abort="Abort"}(Qe||(Qe={})),function(e){e.Left="left",e.Right="right"}(We||(We={})),function(e){e.Comment="commentCard"}(Ge||(Ge={})),function(e){e.Complete="complete",e.Incomplete="incomplete"}(Ye||(Ye={})),function(e){e.Green="green",e.Yellow="yellow",e.Orange="orange",e.Red="red",e.Purple="purple",e.Blue="blue",e.Sky="sky",e.Lime="lime",e.Pink="pink",e.Black="black"}(Xe||(Xe={})),function(e){e.Top="top",e.Bottom="bottom"}(Je||(Je={})),function(e){e[e.Info=0]="Info",e[e.Warn=1]="Warn",e[e.Error=2]="Error"}(Ze||(Ze={}));const Ke={id:"trello-plugin-icon-trello",svgContent:'<g><path fill="currentColor" stroke="currentColor" style="stroke:none;fill-rule:nonzero;fill-opacity:1;" d="M 82 8 L 18 8 C 12.480469 8 8 12.480469 8 18 L 8 82 C 8 87.519531 12.480469 92 18 92 L 82 92 C 87.519531 92 92 87.519531 92 82 L 92 18 C 92 12.480469 87.519531 8 82 8 Z M 42 72 C 42 74.199219 40.199219 76 38 76 L 24 76 C 21.800781 76 20 74.199219 20 72 L 20 24 C 20 21.800781 21.800781 20 24 20 L 38 20 C 40.199219 20 42 21.800781 42 24 Z M 80 48 C 80 50.199219 78.199219 52 76 52 L 62 52 C 59.800781 52 58 50.199219 58 48 L 58 24 C 58 21.800781 59.800781 20 62 20 L 76 20 C 78.199219 20 80 21.800781 80 24 Z M 80 48 "/></g>'},et="https://api.trello.com",tt="The Trello plugin requires an API token for use. Please visit plugin settings.",nt="The Trello API is rate limited. Please try again later.",rt="The Trello plugin requires the MetaEdit plugin.",it="The Trello API rejected your token. Please create a new token.",ot="The Trello API could not be reached. Please create a new token or try again later.",st={token:"",customUi:{global:{checklists:!0,comments:!0,description:!0,labels:!0,list:!0,title:!0}},selectedBoards:[],openToSide:We.Right,newCardPosition:Je.Top,movedCardPosition:Je.Top,verboseLogging:!1},lt={settings:st,version:"1.6.0",firstRun:!0,connectedCards:{}};var at;!function(e){e.BoardCard="trello_board_card_id",e.TrelloId="trello_plugin_note_id"}(at||(at={}));const ct={name:"Create a new card...",id:"CREATE_NEW_TRELLO_CARD"};function ut(e){switch(e.responseType){case"json":if("response"in e)return e.response;var t=e;return JSON.parse(t.responseText);case"document":return e.responseXML;case"text":default:return"response"in e?e.response:(t=e).responseText}}var dt=function(e,t,n,r){void 0===r&&(r="download_load"),this.originalEvent=e,this.xhr=t,this.request=n,this.type=r;var i=t.status,o=t.responseType;this.status=null!=i?i:0,this.responseType=null!=o?o:"";var s=t.getAllResponseHeaders();this.responseHeaders=s?s.split("\n").reduce((function(e,t){var n=t.indexOf(": ");return e[t.slice(0,n)]=t.slice(n+2),e}),{}):{},this.response=ut(t);var l=e.loaded,a=e.total;this.loaded=l,this.total=a},ht=p((function(e){return function(e,t,n){var r;this.message=e,this.name="AjaxError",this.xhr=t,this.request=n,this.status=t.status,this.responseType=t.responseType;try{r=ut(t)}catch(e){r=t.responseText}this.response=r}})),pt=function(){function e(e,t){return ht.call(this,"ajax timeout",e,t),this.name="AjaxTimeoutError",this}return e.prototype=Object.create(ht.prototype),e}();function gt(e,t){return Tt({method:"GET",url:e,headers:t})}function ft(e,t,n){return Tt({method:"POST",url:e,body:t,headers:n})}function vt(e,t){return Tt({method:"DELETE",url:e,headers:t})}function mt(e,t,n){return Tt({method:"PUT",url:e,body:t,headers:n})}function bt(e,t,n){return Tt({method:"PATCH",url:e,body:t,headers:n})}var yt=be((function(e){return e.response}));function wt(e,t){return yt(Tt({method:"GET",url:e,headers:t}))}var Ct,Tt=((Ct=function(e){return function(e){return new _((function(t){var n,i,o,s=e.queryParams,l=e.body,a=e.headers,c=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(e,["queryParams","body","headers"]),u=c.url;if(!u)throw new TypeError("url is required");if(s)if(u.includes("?")){var d=u.split("?");if(2<d.length)throw new TypeError("invalid url");o=new URLSearchParams(d[1]),new URLSearchParams(s).forEach((function(e,t){return o.set(t,e)})),u=d[0]+"?"+o}else u=u+"?"+(o=new URLSearchParams(s));var h={};if(a)for(var p in a)a.hasOwnProperty(p)&&(h[p.toLowerCase()]=a[p]);e.crossDomain||"x-requested-with"in h||(h["x-requested-with"]="XMLHttpRequest");var g=c.withCredentials,f=c.xsrfCookieName,v=c.xsrfHeaderName;if((g||!c.crossDomain)&&f&&v){var m=null!==(i=null===(n=null===document||void 0===document?void 0:document.cookie.match(new RegExp("(^|;\\s*)("+f+")=([^;]*)")))||void 0===n?void 0:n.pop())&&void 0!==i?i:"";m&&(h[v]=m)}var b,y=function(e,t){var n;if(!e||"string"==typeof e||function(e){return"undefined"!=typeof FormData&&e instanceof FormData}(e)||function(e){return"undefined"!=typeof URLSearchParams&&e instanceof URLSearchParams}(e)||function(e){return It(e,"ArrayBuffer")}(e)||function(e){return It(e,"File")}(e)||function(e){return It(e,"Blob")}(e)||function(e){return"undefined"!=typeof ReadableStream&&e instanceof ReadableStream}(e))return e;if(function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView(e)}(e))return e.buffer;if("object"==typeof e)return t["content-type"]=null!==(n=t["content-type"])&&void 0!==n?n:"application/json;charset=utf-8",JSON.stringify(e);throw new TypeError("Unknown body type")}(l,h),w=r(r({async:!0,crossDomain:!0,withCredentials:!1,method:"GET",timeout:0,responseType:"json"},c),{url:u,headers:h,body:y});b=e.createXHR?e.createXHR():new XMLHttpRequest;var C=e.progressSubscriber,T=e.includeDownloadProgress,S=void 0!==T&&T,E=e.includeUploadProgress,k=void 0!==E&&E,x=function(e,n){b.addEventListener(e,(function(){var e,r=n();null===(e=null==C?void 0:C.error)||void 0===e||e.call(C,r),t.error(r)}))};x("timeout",(function(){return new pt(b,w)})),x("abort",(function(){return new ht("aborted",b,w)}));var I=function(e,t){return new dt(t,b,w,e+"_"+t.type)},P=function(e,n,r){e.addEventListener(n,(function(e){t.next(I(r,e))}))};k&&[St,Et,kt].forEach((function(e){return P(b.upload,e,"upload")})),C&&[St,Et].forEach((function(e){return b.upload.addEventListener(e,(function(e){var t;return null===(t=null==C?void 0:C.next)||void 0===t?void 0:t.call(C,e)}))})),S&&[St,Et].forEach((function(e){return P(b,e,"download")}));var L=function(e){var n="ajax error"+(e?" "+e:"");t.error(new ht(n,b,w))};b.addEventListener("error",(function(e){var t;null===(t=null==C?void 0:C.error)||void 0===t||t.call(C,e),L()})),b.addEventListener(kt,(function(e){var n,r,i=b.status;if(i<400){null===(n=null==C?void 0:C.complete)||void 0===n||n.call(C);var o=void 0;try{o=I("download",e)}catch(e){return void t.error(e)}t.next(o),t.complete()}else null===(r=null==C?void 0:C.error)||void 0===r||r.call(C,e),L(i)}));var A=w.user,D=w.method,M=w.async;for(var p in A?b.open(D,u,M,A,w.password):b.open(D,u,M),M&&(b.timeout=w.timeout,b.responseType=w.responseType),"withCredentials"in b&&(b.withCredentials=w.withCredentials),h)h.hasOwnProperty(p)&&b.setRequestHeader(p,h[p]);return y?b.send(y):b.send(),function(){b&&4!==b.readyState&&b.abort()}}))}("string"==typeof e?{url:e}:e)}).get=gt,Ct.post=ft,Ct.delete=vt,Ct.put=mt,Ct.patch=bt,Ct.getJSON=wt,Ct),St="loadstart",Et="progress",kt="load";var xt=Object.prototype.toString;function It(e,t){return xt.call(e)==="[object "+t+"]"}class Pt{constructor(e){this.plugin=e,this.token=new j(""),this.plugin.state.settings.pipe(ze(this.plugin.destroy),be((e=>e.token))).subscribe(this.token)}getBoards(){if(this.plugin.log("TrelloAPI.getBoards",""),""===this.token.value)return me((()=>Qe.NoToken));const e=this.auth(`${et}/1/members/me/boards?fields=name,url`);return Tt({url:e,crossDomain:!0}).pipe(Ue((e=>this.handleAPIError(e))),be((e=>e.response)))}getCardFromBoard(e,t,n=!1,r=12e4){this.plugin.log("TrelloAPI.getCardFromBoard","");const i=this.plugin.state.cardCache[t];return!i||n||(new Date).getTime()-i.timestamp.getTime()>r?this._getCardFromBoard(e,t):(this.plugin.log("TrelloAPI.getCardFromBoard","-> Returning cached value."),ve(i.item))}_getCardFromBoard(e,t){if(""===this.token.value)return me((()=>Qe.NoToken));const n=this.auth(`${et}/1/boards/${e}/cards/${t}`);return Tt({url:n,crossDomain:!0}).pipe(Ue((e=>this.handleAPIError(e))),be((e=>e.response)),He((e=>{e&&(this.plugin.state.cardCache[e.id]={item:e,timestamp:new Date})})))}getLabelsFromBoard(e,t=!1,n=6e5){this.plugin.log("TrelloAPI.getLabelsFromBoard","");const r=this.plugin.state.labelCache[e];return!r||t||(new Date).getTime()-r.timestamp.getTime()>n?this._getLabelsFromBoard(e):(this.plugin.log("TrelloAPI.getLabelsFromBoard","-> Returning cached value."),ve(r.item))}_getLabelsFromBoard(e){if(""===this.token.value)return me((()=>Qe.NoToken));const t=this.auth(`${et}/1/boards/${e}/labels`);return Tt({url:t,crossDomain:!0}).pipe(Ue((e=>this.handleAPIError(e))),be((e=>e.response)),He((t=>{this.plugin.state.labelCache[e]={item:t,timestamp:new Date}})))}getListsFromBoard(e){if(this.plugin.log("TrelloAPI.getListsFromBoard",""),""===this.token.value)return me((()=>Qe.NoToken));const t=this.auth(`${et}/1/boards/${e}/lists`);return Tt({url:t,crossDomain:!0}).pipe(Ue((e=>this.handleAPIError(e))),be((e=>e.response)),He((e=>{e&&e.length>0&&e.forEach((e=>{this.plugin.state.listCache[e.id]={item:e,timestamp:new Date}}))})))}getList(e,t=!1,n=6e5){this.plugin.log("TrelloAPI.getList","");const r=this.plugin.state.listCache[e];return!r||t||(new Date).getTime()-r.timestamp.getTime()>n?this._getList(e):(this.plugin.log("TrelloAPI.getList","-> Returning cached value."),ve(r.item))}_getList(e){if(""===this.token.value)return me((()=>Qe.NoToken));const t=this.auth(`${et}/1/lists/${e}`);return Tt({url:t,crossDomain:!0}).pipe(Ue((e=>this.handleAPIError(e))),be((e=>e.response)),He((e=>{e&&(this.plugin.state.listCache[e.id]={item:e,timestamp:new Date})})))}getCardsFromBoard(e){if(this.plugin.log("TrelloAPI.getCardsFromBoard",""),""===this.token.value)return me((()=>Qe.NoToken));const t=this.auth(`${et}/1/boards/${e}/cards`);return Tt({url:t,crossDomain:!0}).pipe(Ue((e=>this.handleAPIError(e))),be((e=>e.response)),He((e=>{e.forEach((e=>{this.plugin.state.cardCache[e.id]={item:e,timestamp:new Date}}))})))}getActionsFromCard(e,t=[Ge.Comment],n=!1,r=6e4){this.plugin.log("TrelloAPI.getActionsFromCard","");const i=this.plugin.state.cardActionsCache[e];return!i||n||(new Date).getTime()-i.timestamp.getTime()>r?this._getActionsFromCard(e,t):(this.plugin.log("TrelloAPI.getActionsFromCard","-> Returning cached value."),ve(i.item))}_getActionsFromCard(e,t=[Ge.Comment]){if(""===this.token.value)return me((()=>Qe.NoToken));const n=this.auth(`${et}/1/cards/${e}/actions?filter=${t.join(",")}`);return Tt({url:n,crossDomain:!0}).pipe(Ue((e=>this.handleAPIError(e))),be((e=>e.response)),He((t=>{t&&(this.plugin.state.cardActionsCache[e]={item:t,timestamp:new Date})})))}getChecklistsFromCard(e,t=[],n=!1,r=6e4){this.plugin.log("TrelloAPI.getChecklistsFromCard","");const i=t.map((e=>this.plugin.state.checklistCache[e])),o=(new Date).getTime();return!i||n||i.some((e=>void 0===e||o-e.timestamp.getTime()>r))?this._getChecklistsFromCard(e):(this.plugin.log("TrelloAPI.getChecklistsFromCard","-> Returning cached value."),ve(i.map((e=>e.item))))}_getChecklistsFromCard(e){if(""===this.token.value)return me((()=>Qe.NoToken));const t=this.auth(`${et}/1/cards/${e}/checklists`);return Tt({url:t,crossDomain:!0}).pipe(Ue((e=>this.handleAPIError(e))),be((e=>e.response)),He((e=>{if(e&&e.length>0){const t=new Date;e.forEach((e=>{this.plugin.state.checklistCache[e.id]={item:e,timestamp:t}}))}})))}getChecklist(e,t=!1,n=6e4){this.plugin.log("TrelloAPI.getChecklist","");const r=this.plugin.state.checklistCache[e];return!r||t||(new Date).getTime()-r.timestamp.getTime()>n?this._getChecklist(e):(this.plugin.log("TrelloAPI.getChecklist","-> Returning cached value."),ve(r.item))}_getChecklist(e){if(""===this.token.value)return me((()=>Qe.NoToken));const t=this.auth(`${et}/1/checklists/${e}`);return Tt({url:t,crossDomain:!0}).pipe(Ue((e=>this.handleAPIError(e))),be((e=>e.response)),He((t=>{t&&(this.plugin.state.checklistCache[e]={item:t,timestamp:new Date})})))}addCommentToCard(e,t){if(this.plugin.log("TrelloAPI.addCommentToCard",""),""===this.token.value)return me((()=>Qe.NoToken));const n=this.auth(`${et}/1/cards/${e}/actions/comments?text=${encodeURIComponent(t)}`);return Tt({url:n,method:"POST",crossDomain:!0}).pipe(Ue((e=>this.handleAPIError(e))))}addNewCard(e){if(this.plugin.log("TrelloAPI.addNewCard",""),""===this.token.value)return me((()=>Qe.NoToken));let t=this.auth(`${et}/1/cards`);return t=this.addQueryParam(t,"idList",e.idList),t=this.addQueryParam(t,"name",e.name,!0),t=this.addQueryParam(t,"desc",e.desc,!0),t=this.addQueryParam(t,"pos",e.pos),t=this.addQueryParam(t,"idLabels",e.idLabels?e.idLabels.join(","):void 0),Tt({url:t,method:"POST",crossDomain:!0}).pipe(Ue((e=>this.handleAPIError(e))))}updateCardList(e,t,n=Je.Top){return this.plugin.log("TrelloAPI.updateCardList",""),this.updateCard({id:e,idList:t,pos:n})}updateCheckItemState(e,t,n){return this.plugin.log("TrelloAPI.updateCheckItemState",""),this.updateCheckItem(e,{id:t,state:n})}updateCard(e){if(this.plugin.log("TrelloAPI.updateCard",""),""===this.token.value)return me((()=>Qe.NoToken));let t=this.auth(`${et}/1/cards/${e.id}`);return t=this.addQueryParam(t,"name",e.name,!0),t=this.addQueryParam(t,"desc",e.desc,!0),t=this.addQueryParam(t,"idBoard",e.idBoard),t=this.addQueryParam(t,"idList",e.idList),t=this.addQueryParam(t,"due",e.due),t=this.addQueryParam(t,"idAttachmentCover",e.idAttachmentCover),e.idLabels&&(t=this.addQueryParam(t,"idLabels",e.idLabels.join(","))),void 0!==e.dueComplete&&(t=this.addQueryParam(t,"dueComplete",e.dueComplete.toString())),Tt({url:t,method:"PUT",crossDomain:!0}).pipe(Ue((e=>this.handleAPIError(e))),be((e=>e.response)))}updateCheckItem(e,t){if(this.plugin.log("TrelloAPI.updateCheckItem",""),""===this.token.value)return me((()=>Qe.NoToken));let n=this.auth(`${et}/1/cards/${e}/checkItem/${t.id}`);return n=this.addQueryParam(n,"name",t.name,!0),n=this.addQueryParam(n,"state",t.state,!0),n=this.addQueryParam(n,"idChecklist",t.idChecklist),Tt({url:n,method:"PUT",crossDomain:!0}).pipe(Ue((e=>this.handleAPIError(e))),be((e=>e.response)))}auth(e){return`${e}${e.includes("?")?"&":"?"}key=9537467993aefd6dca9ee7788179c298&token=${this.token.value}`}addQueryParam(e,t,n,r=!1){return n?`${e}${e.includes("?")?"&":"?"}${t}=${r?encodeURIComponent(n):n}`:e}handleAPIError(e){return me((()=>{if(!(e instanceof ht))return Qe.Unknown;switch(e.status){case 401:return Qe.Unauthorized;case 429:return Qe.RateLimit;default:return Qe.Unknown}}))}}class Lt extends e.Modal{constructor(e,t){super(e),this.plugin=t,this.selectedBoards=this.plugin.state.settings.pipe(Ve(1),be((e=>e.selectedBoards?e.selectedBoards:[]))),this.newState={}}onOpen(){this.contentEl.empty(),_e({selected:this.selectedBoards,boards:this.plugin.api.getBoards()}).subscribe({next:({selected:e,boards:t})=>{const n=this.contentEl.createDiv("trello-board-select--container");n.createEl("h2",{text:"Boards",cls:"trello-board-select--title"}),this.newState={},e.forEach((e=>{this.newState[e.id]=e})),t.forEach((e=>{this.buildToggle(e,n)}));const r=this.contentEl.createDiv("trello-board-select--controls");r.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",(()=>{this.onSave()}));r.createEl("button",{text:"Cancel"}).addEventListener("click",(()=>{this.close()}))},error:()=>{if(this.plugin.state.currentToken.value&&""!==this.plugin.state.currentToken.value)new e.Notice(ot),this.close();else{this.contentEl.createDiv({cls:"trello-board-select--empty-state",text:"An API token is required."}).createEl("button",{text:"Setup Trello"}).addEventListener("click",(()=>{this.plugin.openTrelloSettings(),this.close()}))}}})}onClose(){this.contentEl.empty()}buildToggle(e,t){const n=t.createDiv("trello-board-select--toggle-container");n.createDiv({text:e.name,cls:"trello-board-select--toggle-label"});const r=n.createDiv({cls:"trello-board-select--toggle checkbox-container"});this.newState[e.id]&&r.addClass("is-enabled"),n.addEventListener("click",(()=>{this.newState[e.id]?(r.removeClass("is-enabled"),delete this.newState[e.id]):(r.addClass("is-enabled"),this.newState[e.id]=e)}))}onSave(){const e=Object.values(this.newState);this.plugin.state.updateSetting("selectedBoards",e),this.close()}}class At extends e.SuggestModal{constructor(e){super(e),this.selected=new $,this.options=[],this.selectionMade=!1}onOpen(){this.selectionMade=!1,super.onOpen()}onClose(){this.selectionMade||(this.selected.error(Qe.Abort),this.selected.complete(),this.selected=new $),super.onClose()}selectSuggestion(e,t){this.selectionMade=!0,super.selectSuggestion(e,t)}onChooseSuggestion(e){this.selected.next(e),this.selected.complete(),this.selected=new $}}class Dt extends At{constructor(e){super(e),this.setInstructions([{command:"",purpose:"Select a Trello board"}])}getSuggestions(e){const t=e.toLowerCase();return this.options.filter((e=>e.name.toLowerCase().includes(t)))}renderSuggestion(e,t){t.setText(e.name)}}class Mt{constructor(e,t=!0){this.parent=e,this.openOne=t,this.sections=[]}addSection(t){const n=this.parent.createDiv("trello-accordion--container"),r=n.createDiv("trello-accordion--title");r.createSpan({text:t,cls:"trello-accordion--title-text"});const i=r.createSpan("trello-accordion--title-icon");e.setIcon(i,"left-chevron-glyph");const o=n.createDiv("trello-accordion--content"),s={containerEl:n,titleEl:r,titleIcon:i,contentEl:o,expanded:!1};return s.titleEl.addEventListener("click",(()=>{s.expanded?this.collapseSection(s):this.expandSection(s)})),this.sections.push(s),s}expandSection(e){this.openOne&&this.sections.forEach((t=>{t!==e&&this.collapseSection(t)})),e.expanded=!0,e.titleIcon.addClass("trello-accordion--expanded"),e.contentEl.style.maxHeight=e.contentEl.scrollHeight+"px"}collapseSection(e){e.expanded=!1,e.titleIcon.removeClass("trello-accordion--expanded"),e.contentEl.style.maxHeight=""}}class _t extends e.Modal{constructor(e,t){super(e),this.plugin=t,this.labels=[],this.createdCard=new $,this.selectedLabels={},this.finishedCardCreation=!1}onOpen(){this.contentEl.empty();const e=this.contentEl.createDiv();this.title=this.renderTitle(e);const t=new Mt(e),n=t.addSection("Description"),r=t.addSection("Labels");this.description=this.renderDescription(n.contentEl),this.renderLabels(r.contentEl),this.position=this.renderPositionSelect(e);const i=e.createDiv("trello-card-create--controls");i.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",this.onSave.bind(this));i.createEl("button",{text:"Cancel"}).addEventListener("click",this.close.bind(this))}onClose(){this.finishedCardCreation||this.createdCard.error(Qe.Abort),this.reset()}onSave(){this.plugin.api.addNewCard({idList:this.list.id,idLabels:Object.values(this.selectedLabels).map((e=>e.id)),name:this.title.value,desc:this.description.value,pos:this.position.value}).pipe(be((e=>e.response))).subscribe({next:e=>{this.finishedCardCreation=!0,this.createdCard.next(e),this.close()},error:e=>{this.finishedCardCreation=!0,this.createdCard.error(e)}})}reset(){this.selectedLabels={},this.createdCard=new $,this.title.value="",this.description.value="",this.finishedCardCreation=!1}renderTitle(e){return e.createEl("input",{cls:"trello-card-create--title",attr:{placeholder:"Enter a title for this card..."}})}renderDescription(e){return e.createDiv("trello-card-create--desc-wrapper").createDiv({cls:"trello-card-create--desc-container"}).createEl("textarea",{cls:"trello-card-create--desc",attr:{onInput:"this.parentNode.dataset.replicatedValue = this.value",placeholder:"Add a more detailed description..."}})}renderLabels(e){const t=e.createDiv("trello-card-create--labels");this.labels.forEach((e=>{this.renderLabel(e,t)}))}renderLabel(e,t){const n=t.createDiv("trello-card-create--label-container");e.color?n.addClass(`label-color--${e.color}`):n.addClass("label-color--grey"),n.createSpan({text:e.name,cls:"trello-card-create--label-name"}),this.buildCheck(e,n)}buildCheck(t,n){const r=n.createSpan({cls:"trello-card-create--check"});n.addEventListener("click",(()=>{this.selectedLabels[t.id]?(r.empty(),delete this.selectedLabels[t.id]):(e.setIcon(r,"checkbox-glyph",20),this.selectedLabels[t.id]=t)}))}renderPositionSelect(e){const t=e.createDiv("trello-card-create--position-select-container");t.createEl("label",{text:"Add new card to",attr:{for:"trello-card-create--position-select"}});const n=t.createEl("select",{cls:"dropdown",attr:{id:"trello-card-create--position-select"}});return n.createEl("option",{text:"Top",attr:{value:Je.Top}}),n.createEl("option",{text:"Bottom",attr:{value:Je.Bottom}}),n.value=this.defaultPosition,n}}class Ot extends At{constructor(e){super(e),this.setInstructions([{command:"",purpose:"Select a Trello card"}])}getSuggestions(e){const t=e.toLowerCase();return[ct,...this.options.filter((e=>e.name.toLowerCase().includes(t)))]}renderSuggestion(e,t){t.setText(e.name)}}class Nt extends e.Modal{constructor(t,n){super(t),this.plugin=n,this.source=new j(null),Ie({customUi:this.plugin.state.settings.pipe(ze(this.plugin.destroy),be((e=>e.customUi))),source:this.source.pipe(Be((e=>null!==e)),ze(this.plugin.destroy))}).pipe(be((({customUi:e,source:t})=>e[t]?(this.plugin.log("CustomizeUIModal",`Customizing ui config for trello ID ${t}`),e[t]):(this.plugin.log("CustomizeUIModal","Customizing global UI config"),e.global)))).subscribe((t=>{this.plugin.log("CustomizeUIModal","Building Customize UI modal");const n=this.source.value;this.contentEl.empty(),this.newState=Object.assign({},t),new e.Setting(this.contentEl).setName("Title").addToggle((e=>{e.setValue(t.title).onChange((e=>this.newState.title=e))})),new e.Setting(this.contentEl).setName("Description").addToggle((e=>{e.setValue(t.description).onChange((e=>this.newState.description=e))})),new e.Setting(this.contentEl).setName("List").addToggle((e=>{e.setValue(t.list).onChange((e=>this.newState.list=e))})),new e.Setting(this.contentEl).setName("Comments").addToggle((e=>{e.setValue(t.comments).onChange((e=>this.newState.comments=e))})),new e.Setting(this.contentEl).setName("Labels").addToggle((e=>{e.setValue(t.labels).onChange((e=>this.newState.labels=e))})),new e.Setting(this.contentEl).setName("Checklists").addToggle((e=>{e.setValue(t.checklists).onChange((e=>this.newState.checklists=e))}));const r=this.contentEl.createDiv();if("global"!==n){r.createEl("button",{text:"Reset to Default"}).addEventListener("click",(()=>{this.plugin.log("CustomizeUIModal",`Resetting UI config for trello ID ${n}`),this.plugin.state.updateCustomUI(n,null),this.plugin.view.updateCard(),this.close()}))}r.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",(()=>{this.plugin.log("CustomizeUIModal",`Saving UI config for trello ID ${n}`),this.plugin.state.updateCustomUI(n,this.newState),this.close()}))}))}}class Bt extends At{constructor(e){super(e),this.setInstructions([{command:"",purpose:"Select a Trello list"}])}getSuggestions(e){const t=e.toLowerCase();return this.options.filter((e=>e.name.toLowerCase().includes(t)))}renderSuggestion(e,t){t.setText(e.name)}}class Ut extends e.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t,this.boardSelectModal=new Lt(this.plugin.app,this.plugin)}display(){return i(this,void 0,void 0,(function*(){this.plugin.log("TrelloSettings.display","Initializing settings"),this.containerEl.empty(),this.containerEl.createEl("h2",{text:"Obsidian Trello settings."}),this.plugin.state.settings.pipe(Ve(1)).subscribe((e=>{this.buildTokenSetting(this.containerEl,e),this.buildUiConfigSetting(this.containerEl),this.buildBoardSelectSetting(this.containerEl),this.buildOpenToSideSetting(this.containerEl,e),this.buildNewCardPositionSetting(this.containerEl,e),this.buildMovedCardPositionSetting(this.containerEl,e),this.buildVerboseLoggingSetting(this.containerEl,e)}))}))}buildTokenSetting(t,n){return i(this,void 0,void 0,(function*(){this.plugin.log("TrelloSettings.buildTokenSetting",`-> Adding token setting with initial value ${n.token}`);const r=new DocumentFragment;r.createDiv({cls:"setting-item-description"}).innerHTML='Your API token. <a href="https://trello.com/1/authorize?expiration=never&scope=read,write&response_type=token&name=Obsidian%20Trello%20Token&key=9537467993aefd6dca9ee7788179c298">Generate one</a> then copy it here. This token can be revoked at any time in your Trello account settings.',new e.Setting(t).setName("Trello Token").setDesc(r).addText((e=>{e.setPlaceholder("Enter token").setValue(n.token).onChange((e=>{this.plugin.state.updateSetting("token",e.trim()),this.plugin.view.updateCard()}))}))}))}buildUiConfigSetting(t){this.plugin.log("TrelloSettings.buildConfigSetting","-> Adding UI config setting"),new e.Setting(t).setName("Customize UI").setDesc("Configure which parts of connected trello cards are displayed by default. Can be overridden per note.").addButton((e=>{e.setButtonText("Configure").onClick((()=>{this.plugin.customizeUIModal.source.next("global"),this.plugin.customizeUIModal.open()}))}))}buildBoardSelectSetting(t){this.plugin.log("TrelloSettings.buildBoardSelectSetting","-> Adding board select setting"),new e.Setting(t).setName("Select Boards").setDesc("These boards will be available to select cards from.").addButton((e=>{e.setButtonText("Select").onClick((()=>{this.boardSelectModal.open()}))}))}buildOpenToSideSetting(t,n){this.plugin.log("TrelloSettings.buildOpenToSideSetting",`-> Adding open to side setting with initial value ${n.openToSide}`),new e.Setting(t).setName("Open to Side").setDesc("Whether the Trello pane should open to the left or right side.").addDropdown((e=>{e.addOption(We.Right,"Right").addOption(We.Left,"Left").setValue(n.openToSide).onChange((e=>{this.plugin.state.updateSetting("openToSide",e)}))}))}buildNewCardPositionSetting(t,n){this.plugin.log("TrelloSettings.buildNewCardPositionSetting",`-> Adding new card position setting with initial value ${n.newCardPosition}`),new e.Setting(t).setName("New Card Position").setDesc("Whether newly created cards should be added to the top or bottom of the list by default. Can be overridden when adding a card.").addDropdown((e=>{e.addOption(Je.Top,"Top").addOption(Je.Bottom,"Bottom").setValue(n.newCardPosition).onChange((e=>{this.plugin.state.updateSetting("newCardPosition",e)}))}))}buildMovedCardPositionSetting(t,n){this.plugin.log("TrelloSettings.buildMovedCardPositionSetting",`-> Adding moved card position setting with initial value ${n.movedCardPosition}`),new e.Setting(t).setName("Moved Card Position").setDesc("When moving a card from one list to another, should it be moved to the top or bottom of the selected list.").addDropdown((e=>{e.addOption(Je.Top,"Top").addOption(Je.Bottom,"Bottom").setValue(n.movedCardPosition).onChange((e=>{this.plugin.state.updateSetting("movedCardPosition",e)}))}))}buildVerboseLoggingSetting(t,n){this.plugin.log("TrelloSettings.buildVerboseLoggingSetting",`-> Adding verbose logging setting with initial value ${n.verboseLogging}`),new e.Setting(t).setName("Verbose Logging").setDesc("Enable this if you're having trouble with the plugin. Logs will be enabled in the console.").addToggle((e=>{e.setValue(n.verboseLogging).onChange((e=>{this.plugin.state.updateSetting("verboseLogging",e)}))}))}}class $t{constructor(e,t){this.plugin=e,this.cardCache={},this.cardActionsCache={},this.listCache={},this.labelCache={},this.checklistCache={},this.boardCardId=new j(null),this.connectedCardId=new j(null),this.currentToken=new j(""),this.verboseLogging=new j(!1),this.data=new j(t),this.data.pipe(ze(e.destroy)).subscribe((e=>i(this,void 0,void 0,(function*(){yield this.plugin.saveData(e)}))))}get settings(){return this.data.pipe(be((e=>e.settings)))}get connectedCards(){return this.data.value.connectedCards}updateSetting(e,t){const n=Object.assign({},this.data.value.settings);n[e]=t,this.data.next(Object.assign(Object.assign({},this.data.value),{settings:n}))}updateConnectedCard(e,t){const n=Object.assign({},this.data.value.connectedCards);t?n[e]=t:delete n[e],this.data.next(Object.assign(Object.assign({},this.data.value),{connectedCards:n}))}updateCustomUI(e,t){const n=Object.assign({},this.data.value.settings.customUi);t?n[e]=t:delete n[e],this.updateSetting("customUi",n)}completedFirstRun(){this.data.next(Object.assign(Object.assign({},this.data.value),{firstRun:!1}))}updateVersion(){this.data.next(Object.assign(Object.assign({},this.data.value),{version:lt.version}))}}class Vt{constructor(e,t,n){this.plugin=e,this.destroy=t,this.update=n,this.bypassActionCache=!1,this.bypassListCache=!1,this.bypassChecklistsCache=!1,this.cardError=null,this.actionsError=null,this.listError=null,this.checklistsError=null,this.connectedId=new j(null),this.currentCard=new j(null),this.currentActions=new j(null),this.currentList=new j(null),this.currentChecklists=new j(null),this.currentUIConfig=new j(null),this.plugin.state.boardCardId.pipe(ze(this.destroy),He((e=>{e||(this.cardError=null,this.actionsError=null,this.listError=null,this.currentCard.next(null),this.currentActions.next(null),this.currentList.next(null))})),Be((e=>null!==e&&""!==e)),Fe((e=>{const[t,n]=e.split(";");return this.plugin.log("TrelloViewManager",`-> Got new board/card ID ${t}/${n}`),this.plugin.log("TrelloViewManager","-> Getting card from API/cache."),this.plugin.api.getCardFromBoard(t,n)}))).subscribe({next:e=>{null!==this.currentCard.value&&this.currentCard.value.id!==e.id&&(this.plugin.log("TrelloViewManager","Card changed, resetting extra info."),this.currentActions.next(null),this.currentList.next(null)),this.cardError=null,this.plugin.log("TrelloViewManager","-> Card updated."),this.currentCard.next(e)},error:e=>{this.cardError=e,this.currentCard.next(null)}}),this.plugin.state.connectedCardId.pipe(ze(this.destroy),He((e=>{e||(this.connectedId.next(null),this.currentUIConfig.next(null))})),Be((e=>null!==e&&""!==e)),He((e=>{this.connectedId.next(e)})),Ae((e=>Ie([ve(e),this.plugin.state.settings.pipe(be((e=>e.customUi)))])))).subscribe((([e,t])=>{const n=t[e]?t[e]:t.global;this.currentUIConfig.next(n),this.plugin.log("TrelloViewManager",`Connected card with ${e}`)})),this.currentCard.pipe(ze(this.destroy),Be((e=>null!==e)),Fe((e=>this.plugin.api.getActionsFromCard(e.id,void 0,this.bypassActionCache))),Re((()=>{this.bypassActionCache=!1}))).subscribe({next:e=>{this.plugin.log("TrelloViewManager","Actions updated."),this.actionsError=null,this.currentActions.next(e)},error:e=>{this.actionsError=e,this.currentActions.next(null)}}),this.currentCard.pipe(ze(this.destroy),Be((e=>null!==e)),Fe((e=>this.plugin.api.getList(e.idList,this.bypassListCache))),Re((()=>{this.bypassListCache=!1}))).subscribe({next:e=>{this.plugin.log("TrelloViewManager","List updated."),this.listError=null,this.currentList.next(e)},error:e=>{this.listError=e,this.currentList.next(null)}}),this.currentCard.pipe(ze(this.destroy),Be((e=>null!==e&&null!==e.idChecklists&&e.idChecklists.length>0)),Fe((e=>this.plugin.api.getChecklistsFromCard(e.id,e.idChecklists,this.bypassChecklistsCache))),be((e=>(e.sort(((e,t)=>e.pos<t.pos?-1:1)),e.forEach((e=>{e.checkItems.sort(((e,t)=>e.pos<t.pos?-1:1))})),e))),Re((()=>{this.bypassChecklistsCache=!1}))).subscribe({next:e=>{this.plugin.log("TrelloViewManager","Checklist updated."),this.checklistsError=null,this.currentChecklists.next(e)},error:e=>{this.checklistsError=e,this.currentChecklists.next(null)}}),this.update.pipe(ze(this.destroy),Be((()=>null!==this.currentCard.value)),He((()=>{this.plugin.log("TrelloViewManager","Refreshing data."),this.bypassActionCache=!0,this.bypassListCache=!0,this.bypassChecklistsCache=!0})),Fe((()=>{const e=this.currentCard.value;return this.plugin.api.getCardFromBoard(e.idBoard,e.id,!0)}))).subscribe({next:e=>{this.cardError=null,e&&(this.plugin.log("TrelloViewManager","-> Got updated card."),this.currentCard.next(e))},error:e=>{this.cardError=e,this.currentCard.next(null)}})}moveCard(){if(this.currentCard.value&&this.currentList.value){this.plugin.log("TrelloViewManager.moveCard","Beginning move card flow");const e=this.currentCard.value,t=this.currentList.value;_e({list:this.plugin.api.getListsFromBoard(e.idBoard).pipe(be((e=>{this.plugin.log("TrelloViewManager.moveCard","-> Marking current list.");const n=e.find((e=>e.id===t.id));return n&&(n.name=`${n.name} (current list)`),e})),$e((e=>(this.plugin.log("TrelloViewManager.moveCard","-> Got all lists for board."),this.plugin.listSuggestModal.options=e,this.plugin.listSuggestModal.open(),this.plugin.listSuggestModal.selected))),Ve(1),He((e=>{this.plugin.log("TrelloViewManager.moveCard",`-> Selected list ${e.id}. Updating card.`)}))),position:this.plugin.state.settings.pipe(Ve(1),be((e=>e.movedCardPosition)),He((e=>{this.plugin.log("TrelloViewManager.moveCard",`-> Moved card position: ${e}`)})))}).pipe($e((({list:t,position:n})=>this.plugin.api.updateCardList(e.id,t.id,n)))).subscribe({next:e=>{this.plugin.log("TrelloViewManager.moveCard","-> Updated card."),this.currentCard.next(e)},error:e=>{Qe.Abort}})}}}class jt extends e.ItemView{constructor(e,t){super(t),this.plugin=e,this.destroy=new $,this.update=new $,this.viewManager=new Vt(this.plugin,this.destroy,this.update),Ie([this.viewManager.currentCard,this.viewManager.currentActions,this.viewManager.currentList,this.viewManager.currentChecklists,this.viewManager.currentUIConfig]).pipe(ze(this.destroy)).subscribe((([e,t,n,r,i])=>{this.contentEl.empty();const o=[this.viewManager.cardError,this.viewManager.actionsError,this.viewManager.listError];o.some((e=>null!==e))?this.renderEmptyView(this.getWorstError(o)):null===e?this.renderEmptyView(null):this.renderConnectedView(e,t,n,r,i)}))}getDisplayText(){return"Trello"}getViewType(){return"trello-plugin"}getIcon(){return Ke.id}onunload(){this.destroy.next(),this.destroy.complete()}updateCard(){this.update.next()}renderPaneContainer(){return this.contentEl.createDiv("trello-pane--container")}renderEmptyView(e){this.plugin.log("TrelloView.renderEmptyView","");const t=this.renderPaneContainer();if(null===e||e===Qe.NoToken)if(t.createEl("h2",{text:"No Trello card connected."}),e===Qe.NoToken){t.createDiv({text:"An API token is required."});t.createEl("button",{text:"Setup Trello",attr:{type:"button"}}).addEventListener("click",(()=>{this.plugin.openTrelloSettings()}))}else{t.createEl("button",{text:"Connect Trello Card",attr:{type:"button"}}).addEventListener("click",(()=>{this.plugin.connectTrelloCard()}))}else if(t.createEl("h2",{text:"Could not reach Trello API."}),e===Qe.RateLimit)t.createDiv({text:nt});else if(e===Qe.Unauthorized){t.createDiv({text:it});t.createEl("button",{text:"Setup Trello",attr:{type:"button"}}).addEventListener("click",(()=>{this.plugin.openTrelloSettings()}))}else t.createDiv({text:ot})}renderConnectedView(e,t,n,r,i){this.plugin.log("TrelloView.renderConnectedView",""),this.renderHeader(this.contentEl);const o=this.renderPaneContainer();if((null==i?void 0:i.list)||(null==i?void 0:i.title)||(null==i?void 0:i.description)){const t=o.createDiv("trello-pane--card-info");(null==i?void 0:i.list)&&n&&this.renderCardList(n,t),i.title&&this.renderCardTitle(e,t),i.description&&e.desc&&this.renderCardDesc(e,t)}if((null==i?void 0:i.labels)&&e.labels&&e.labels.length>0){const t=o.createDiv("trello-pane--label-section");this.renderLabels(e,t)}if(null==i?void 0:i.comments){const n=o.createDiv("trello-pane--comment-section");this.renderCommentSection(e,t,n)}if((null==i?void 0:i.checklists)&&r&&r.length>0){const t=o.createDiv("trello-pane--checklist-section");this.renderChecklistSection(e.id,r,t)}}renderHeader(e){this.plugin.log("TrelloView.renderHeader","");const t=e.createDiv("nav-header").createDiv("nav-buttons-container");this.renderNavButton(t,"Refresh card","reset",(()=>{this.update.next()})),this.renderNavButton(t,"Link another card","link",(()=>{this.plugin.connectTrelloCard()})),this.renderNavButton(t,"Unlink card","trash",(()=>{this.plugin.disconnectTrelloCard()})),this.renderNavButton(t,"Customize UI","gear",(()=>{this.plugin.customizeUIModal.source.next(this.viewManager.connectedId.value),this.plugin.customizeUIModal.open()}))}renderCardList(t,n){this.plugin.log("TrelloView.renderCardList","");const r=n.createEl("a",{cls:"trello-pane--card-info--list",text:t.name,attr:{"aria-label":"Move card",href:"#"}}),i=r.createSpan();e.setIcon(i,"right-arrow-with-tail"),r.addEventListener("click",(()=>{this.viewManager.moveCard()}))}renderCardTitle(t,n){this.plugin.log("TrelloView.renderCardTitle","");const r=n.createEl("h3",{text:t.name}).createEl("a",{attr:{href:t.url,"aria-label":"View on Trello"}});e.setIcon(r,"navigate-glyph",24)}renderCardDesc(t,n){this.plugin.log("TrelloView.renderCardDesc","");const r=n.createDiv("trello-card-desc--container"),i=r.createEl("a",{text:"Description",cls:"trello-card-desc--collapse",href:"#"}),o=i.createSpan("trello-card-desc--collapse-icon");e.setIcon(o,"down-chevron-glyph");const s=r.createDiv({cls:"trello-card-desc--desc"});e.MarkdownRenderer.renderMarkdown(t.desc,s,"",this),i.addEventListener("click",(()=>{s.style.maxHeight?(s.style.maxHeight="",e.setIcon(o,"down-chevron-glyph")):(s.style.maxHeight=s.scrollHeight+"px",e.setIcon(o,"up-chevron-glyph"))}))}renderLabels(e,t){this.plugin.log("TrelloView.renderLabels",""),e.labels.forEach((e=>{if(e.color){t.createDiv({cls:"trello-label-wrapper",attr:{"aria-label":""!==e.name?e.name:null}}).createSpan({cls:`trello-label trello-color--${e.color}`})}}))}renderCommentSection(t,n,r){this.plugin.log("TrelloView.renderCommentSection","");const i=r.createDiv("trello-comment-input--container"),o=i.createDiv({cls:"trello-comment-input--input-container"}).createEl("textarea",{cls:"trello-comment-input--input",attr:{onInput:"this.parentNode.dataset.replicatedValue = this.value",placeholder:"Write a comment..."}});i.createEl("button",{cls:"trello-comment-input--submit",text:"Submit",attr:{type:"button"}}).addEventListener("click",(()=>{o.value&&this.plugin.api.addCommentToCard(t.id,o.value).pipe(He((()=>{o.value=""}))).subscribe((()=>{this.update.next(),new e.Notice("Added comment.")}))})),n&&0!==n.length&&n.forEach((e=>{this.renderComment(e,r)}))}renderComment(t,n){this.plugin.log("TrelloView.renderComment","");const r=n.createDiv("trello-comment--container"),i=r.createDiv("trello-comment--metadata");i.createSpan({text:t.memberCreator.fullName,cls:"trello-comment--creator"}),i.createSpan({text:new Date(t.date).toLocaleString(),cls:"trello-comment--date"});const o=r.createDiv("trello-comment--text-container");e.MarkdownRenderer.renderMarkdown(t.data.text,o,"",this)}renderChecklistSection(e,t,n){this.plugin.log("TrelloView.renderChecklistSection","");const r=n.createDiv("trello-checklist--section"),i=new Mt(r);t.forEach((t=>{this.renderChecklist(e,t,i)}))}renderChecklist(e,t,n){this.plugin.log("TrelloView.renderChecklist","");const r=n.addSection(t.name),i=r.titleEl.querySelector(".trello-accordion--title-text"),o=null==i?void 0:i.createSpan({cls:"trello-checklist--accordion-percent"}),s=r.contentEl.createDiv("trello-checklist--progress-container"),l=s.createSpan("trello-checklist--progress-percent"),a=s.createEl("progress",{cls:"trello-checklist--progress",attr:{max:100}});this.updateProgress(t.checkItems,a,l,o);const c=r.contentEl.createEl("ul","trello-checklist--checklist");t.checkItems.forEach(((n,r)=>{const i=`checkitem-${n.id}`,s=c.createEl("li","trello-checklist--checkitem"),u=s.createEl("input",{cls:"trello-checklist--checkitem-input",attr:{type:"checkbox",id:i}});u.checked=n.state===Ye.Complete,u.addEventListener("change",(i=>{i.preventDefault();let s=Ye.Complete;u.checked||(s=Ye.Incomplete),this.plugin.api.updateCheckItemState(e,n.id,s).subscribe((e=>{u.checked=e.state===Ye.Complete;const n=[...t.checkItems];n[r].state=e.state,this.updateProgress(n,a,l,o),delete this.plugin.state.listCache[t.id]}))})),s.createEl("label",{cls:"trello-checklist--checkitem-label",text:n.name,attr:{for:i}})}))}renderNavButton(t,n,r,i){this.plugin.log("TrelloView.renderNavButton","");const o=t.createDiv({cls:"nav-action-button",attr:{"aria-label":n}});e.setIcon(o,r),o.addEventListener("click",i)}getWorstError(e){this.plugin.log("TrelloView.getWorstError","");let t=null;return e.forEach((e=>{switch(t){case null:case Qe.NoToken:null!==e&&(t=e);break;case Qe.RateLimit:e===Qe.Unauthorized&&(t=e)}})),t}updateProgress(e,t,n,r){this.plugin.log("TrelloView.updateProgress","");const i=e.filter((e=>e.state===Ye.Complete)),o=e.length>0?Math.round(i.length/e.length*100):0;t.value=o,n.innerText=`${o}%`,r.innerText=`(${i.length}/${e.length})`}}function Rt(e,t){!function(e,t){const n=st.customUi.global,r=Object.assign({},t);Object.keys(t).forEach((e=>{r[e]=Object.assign({},n,t[e])})),e.state.updateSetting("customUi",r)}(e,t.settings.customUi),e.state.updateVersion()}class Ft{constructor(e){this.trelloPlugin=e}get available(){const t=!!this.trelloPlugin.app.plugins.plugins.metaedit;return t||(this.trelloPlugin.log("MetaEditWrapper.available","MetaEdit not available.",Ze.Error),new e.Notice(rt)),t}get plugin(){return Object.assign(Object.assign({},this.trelloPlugin.app.plugins.plugins.metaedit.api),{deleteProperty:this.deleteProperty.bind(this)})}updateOrCreateMeta(e,t,n){return le(this.plugin.getPropertyValue(e,n)).pipe($e((r=>r?(this.trelloPlugin.log("MetaEditWrapper.updateOrCreateMeta",`Updating existing meta key ${e} with value ${t} in file ${n.name}`),le(this.plugin.update(e,t,n))):(this.trelloPlugin.log("MetaEditWrapper.updateOrCreateMeta",`Adding new meta key ${e} with value ${t} in file ${n.name}`),le(this.plugin.createYamlProperty(e,t,n))))))}deleteProperty(e,t){return i(this,void 0,void 0,(function*(){if(t){const n=(yield this.trelloPlugin.app.vault.read(t)).split("\n"),r=new RegExp(`^${e}:`),i=n.findIndex((e=>e.match(r))),o=n.filter(((e,t)=>{if(t!=i)return!0})).join("\n");yield this.trelloPlugin.app.vault.modify(t,o)}}))}}class zt extends e.Plugin{constructor(){super(...arguments),this.metaEdit=new Ft(this),this.destroy=new $,this.boardSuggestModal=new Dt(this.app),this.cardCreateModal=new _t(this.app,this),this.cardSuggestModal=new Ot(this.app),this.listSuggestModal=new Bt(this.app)}onload(){return i(this,void 0,void 0,(function*(){const t=yield this.loadData(),n=Object.assign({},lt,t);n.settings=Object.assign({},st,null==t?void 0:t.settings),n.settings.customUi=Object.assign({},st.customUi,null==t?void 0:t.settings.customUi),this.state=new $t(this,n),this.api=new Pt(this),this.customizeUIModal=new Nt(this.app,this),e.addIcon(Ke.id,Ke.svgContent),t&&t.version!==lt.version&&Rt(this,n),this.state.settings.pipe(ze(this.destroy)).subscribe((e=>{this.state.currentToken.next(e.token),this.state.verboseLogging.next(e.verboseLogging)})),this.registerView("trello-plugin",(e=>this.view=new jt(this,e))),this.registerEvent(this.app.workspace.on("file-open",(e=>i(this,void 0,void 0,(function*(){return this.handleFile(e)}))))),this.handleFile(this.app.workspace.getActiveFile()),this.addSettingTab(new Ut(this.app,this)),this.addCommand({id:"trello-plugin-connect-card",name:"Connect Trello card",callback:this.connectTrelloCard.bind(this),icon:"link"}),this.addCommand({id:"trello-plugin-disconnect-card",name:"Disconnect Trello card",callback:this.disconnectTrelloCard.bind(this),icon:"trash"}),this.addCommand({id:"trello-plugin-reveal-leaf",name:"Show Trello view",callback:()=>{this.revealTrelloLeaf(!0)},icon:Ke.id}),n.firstRun&&(this.revealTrelloLeaf(!0),this.state.completedFirstRun())}))}onunload(){this.destroy.next(),this.destroy.complete(),this.app.workspace.detachLeavesOfType("trello-plugin")}openTrelloSettings(){this.log("TrelloPlugin.openTrelloSettings","Opening settings"),this.app.setting.openTabById("obsidian-trello"),this.app.setting.open()}log(e,t,n=Ze.Info){if(this.state.verboseLogging.value){const r=`OBISIDAN-TRELLO: (${e}) ${t}`;switch(n){case Ze.Warn:console.warn(r);break;case Ze.Error:console.error(r);break;case Ze.Info:default:console.log(r)}}}handleFile(e){return i(this,void 0,void 0,(function*(){if(!e||!this.metaEdit.available)return;const t=yield this.metaEdit.plugin.getPropertyValue(at.BoardCard,e);let n=yield this.metaEdit.plugin.getPropertyValue(at.TrelloId,e);if(t&&!n){const r=qe(),[i,o]=t.split(";");yield this.metaEdit.plugin.createYamlProperty(at.TrelloId,r,e),yield new Promise((e=>window.setTimeout(e,30))),this.state.updateConnectedCard(r,{boardId:i,cardId:o}),n=r}if(!t)return this.log("TrelloPlugin.handleFile","File not trello connected"),this.state.boardCardId.next(null),void this.state.connectedCardId.next(null);this.log("TrelloPlugin.handleFile",`File trello connected, board/card ID ${t}, plugin ID ${n}`),this.state.boardCardId.next(t),this.state.connectedCardId.next(n)}))}connectTrelloCard(){var t;const n=null===(t=this.app.workspace.activeLeaf)||void 0===t?void 0:t.view;let r;n instanceof e.FileView&&this.metaEdit.available&&(this.log("TrelloPlugin.connectTrelloCard","Connecting trello card"),this.state.settings.pipe(Ve(1),be((e=>e.selectedBoards)),$e((e=>Oe((()=>e.length>0),ve(e),this.api.getBoards()))),He((()=>{this.log("TrelloPlugin.connectTrelloCard","-> Got boards")})),$e((e=>this.selectBoard(e))),He((e=>{this.log("TrelloPlugin.connectTrelloCard",`-> Selected board ${e.id}`),r=e})),$e((e=>this.api.getCardsFromBoard(e.id))),He((e=>{this.log("TrelloPlugin.connectTrelloCard",`-> Got ${e.length} cards.`)})),$e((e=>this.selectCard(e))),He((e=>{this.log("TrelloPlugin.connectTrelloCard",`-> Selected card ${e.id}`)})),$e((e=>Oe((()=>e===ct),this.addNewCard(r).pipe(He((()=>{this.log("TrelloPlugin.connectTrelloCard","Beginning add new card flow.")}))),ve(e).pipe(He((()=>{this.log("TrelloPlugin.connectTrelloCard","-> Selected existing card")})))))),$e((e=>_e({selectedCard:ve(e),existingId:le(this.metaEdit.plugin.getPropertyValue(at.TrelloId,n.file))}))),be((({selectedCard:e,existingId:t})=>{const n=t||qe();this.log("TrelloPlugin.connectTrelloCard",`-> Updating file with plugin ID ${n}`),this.state.updateConnectedCard(n,{cardId:e.id,boardId:e.idBoard}),this.state.connectedCardId.next(n);const r=`${e.idBoard};${e.id}`;return this.log("TrelloPlugin.connectTrelloCard",`-> Updating file with board/card ID ${r}`),this.state.boardCardId.next(r),{boardCardId:r,trelloId:n}})),$e((({boardCardId:e,trelloId:t})=>Me(this.metaEdit.updateOrCreateMeta(at.TrelloId,t,n.file).pipe(He((()=>{this.log("TrelloPlugin.connectTrelloCard","-> Adding plugin ID meta key.")})),function(e,t){void 0===t&&(t=Q);var n=Ne(e,t);return je((function(){return n}))}(30)),this.metaEdit.updateOrCreateMeta(at.BoardCard,e,n.file).pipe(He((()=>{this.log("TrelloPlugin.connectTrelloCard","-> Adding board/card ID meta key.")}))))))).subscribe({next:()=>{this.log("TrelloPlugin.connectTrelloCard","-> Done connecting card."),this.revealTrelloLeaf(!0)},error:t=>{t===Qe.Abort?this.log("TrelloPlugin.connectTrelloCard","-> Aborting connect flow."):t===Qe.Unauthorized?(this.log("TrelloPlugin.connectTrelloCard","-> API returned unauthorized.",Ze.Error),new e.Notice(it)):t===Qe.RateLimit?(this.log("TrelloPlugin.connectTrelloCard","-> API returned rate limit error.",Ze.Error),new e.Notice(nt)):t===Qe.NoToken?(this.log("TrelloPlugin.connectTrelloCard","-> No token present.",Ze.Error),new e.Notice(tt)):t===Qe.Unknown&&(this.log("TrelloPlugin.connectTrelloCard","-> Caught unknown error.",Ze.Error),new e.Notice(ot))}}))}disconnectTrelloCard(){var t;return i(this,void 0,void 0,(function*(){const n=null===(t=this.app.workspace.activeLeaf)||void 0===t?void 0:t.view;if(n instanceof e.FileView&&this.metaEdit.available){this.log("TrelloPlugin.disconnectTrelloCard","Disconnecting trello connected card.");const e=yield this.metaEdit.plugin.getPropertyValue(at.TrelloId,n.file);e&&(yield this.metaEdit.plugin.deleteProperty(at.TrelloId,n.file),yield new Promise((e=>window.setTimeout(e,30))),this.state.updateConnectedCard(e,null),this.state.connectedCardId.next(null),this.log("TrelloPlugin.disconnectTrelloCard","-> Removed plugin ID.")),yield this.metaEdit.plugin.deleteProperty(at.BoardCard,n.file),this.state.boardCardId.next(null),this.log("TrelloPlugin.disconnectTrelloCard","-> Removed board/card ID.")}}))}selectBoard(e){return this.boardSuggestModal.options=e,this.boardSuggestModal.open(),this.boardSuggestModal.selected.pipe(Ve(1))}selectCard(e){return this.cardSuggestModal.options=e,this.cardSuggestModal.open(),this.cardSuggestModal.selected.pipe(Ve(1))}addNewCard(e){return _e({labels:this.api.getLabelsFromBoard(e.id),list:this.api.getListsFromBoard(e.id).pipe($e((e=>(this.listSuggestModal.options=e,this.listSuggestModal.open(),this.listSuggestModal.selected))),Ve(1)),settings:this.state.settings.pipe(Ve(1))}).pipe($e((({labels:t,list:n,settings:r})=>(this.log("TrelloPlugin.addNewCard","-> All add new card observables emitted, setting up card create modal."),this.cardCreateModal.board=e,this.cardCreateModal.list=n,this.cardCreateModal.labels=t,this.cardCreateModal.defaultPosition=r.newCardPosition,this.cardCreateModal.open(),this.cardCreateModal.createdCard))),Ve(1))}revealTrelloLeaf(e=!1){this.log("TrelloPlugin.revealTrelloLeaf","Revealing trello leaf.");const t=this.app.workspace.getLeavesOfType("trello-plugin");0===t.length?(this.log("TrelloPlugin.revealTrelloLeaf","-> No trello leaf found, creating."),this.state.settings.pipe(Ve(1),be((e=>e.openToSide))).subscribe((t=>{this.log("TrelloPlugin.revealTrelloLeaf",`-> Creating leaf on ${t} side.`);const n=t===We.Right?this.app.workspace.getRightLeaf(!1):this.app.workspace.getLeftLeaf(!1);n.setViewState({type:"trello-plugin"}),e&&(this.log("TrelloPlugin.revealTrelloLeaf","-> Leaf created, revealing."),this.app.workspace.revealLeaf(n))}))):e&&(this.log("TrelloPlugin.revealTrelloLeaf","-> Trello leaf found, revealing."),this.app.workspace.revealLeaf(t[0]))}}module.exports=zt;
